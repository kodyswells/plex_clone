<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mini Local Plex – Test Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f1115; --panel:#161a22; --text:#e7eaf1; --muted:#9aa3b2; --accent:#5aa9ff; }
    html,body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    header { padding:16px 20px; background:var(--panel); border-bottom:1px solid #222832; }
    header h1 { margin:0; font-size:18px; letter-spacing:.2px; }
    main { display:grid; grid-template-columns: 340px 1fr; gap:16px; padding:16px; height:calc(100% - 57px); box-sizing:border-box; }
    .card { background:var(--panel); border:1px solid #222832; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }
    .card header { background:transparent; border:none; padding:12px 14px; }
    .card .content { padding:12px 14px; overflow:auto; }
    input[type="text"], input[type="number"], select {
      width:100%; box-sizing:border-box; background:#0c0f14; color:var(--text);
      border:1px solid #202632; padding:9px 10px; border-radius:8px; outline:none;
    }
    input[type="text"]::placeholder { color:var(--muted); }
    button {
      background:var(--accent); color:#061018; border:0; padding:10px 12px; border-radius:10px;
      font-weight:600; cursor:pointer; transition:transform .06s ease, opacity .2s ease;
    }
    button:hover { transform:translateY(-1px); }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
    .col { flex:1; }
    .list { height:380px; overflow:auto; border:1px solid #202632; border-radius:8px; }
    .item { padding:10px 12px; border-bottom:1px solid #202632; cursor:pointer; }
    .item:hover { background:#10141c; }
    .item.active { background:#0d1a28; border-left:3px solid var(--accent); padding-left:9px; }
    video { width:100%; max-height:70vh; background:#000; border-radius:12px; border:1px solid #222832; }
    .muted { color:var(--muted); font-size:12px; }
    .urlbar { font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    .controls button { flex:0 0 auto; }
    .pill { background:#0c0f14; border:1px solid #202632; padding:6px 8px; border-radius:999px; font-size:12px; color:var(--muted); }
    footer { padding:8px 14px; border-top:1px solid #222832; background:#0d1118; font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Mini Local Plex – Test Player</h1>
  </header>

  <main>
    <!-- LEFT: Library -->
    <section class="card">
      <header><strong>Library</strong></header>
      <div class="content">
        <div class="row">
          <input id="filter" type="text" placeholder="Filter by filename…" />
        </div>
        <div id="list" class="list" role="listbox" aria-label="Media files"></div>
        <div class="row" style="margin-top:10px">
          <span class="pill"><span id="count">0</span> files</span>
          <span class="muted" style="margin-left:auto">Source: /api/media/path/list</span>
        </div>
      </div>
      <footer>
        Tip: Click an item to select. Press <strong>Enter</strong> to play.
      </footer>
    </section>

    <!-- RIGHT: Player -->
    <section class="card">
      <header><strong>Player</strong></header>
      <div class="content">
        <video id="player" controls playsinline></video>

        <div class="row" style="margin-top:12px">
          <div class="col">
            <label class="muted">Selected path</label>
            <div id="selected" class="urlbar">—</div>
          </div>
        </div>

        <div class="row controls">
          <div class="col" style="max-width:160px">
            <label class="muted">Start time (s)</label>
            <input id="start" type="number" min="0" step="1" value="0" />
          </div>
          <button id="btnPlayAuto" title="Use /api/media/auto (direct stream if native, otherwise transcode)">Play (Auto)</button>
          <button id="btnForceTranscode" title="Force /api/media/transcode at 720p/3Mbps">Force Transcode</button>
          <button id="btnStop">Stop</button>
          <a id="rawLink" class="pill" href="#" target="_blank" rel="noopener">Open stream in new tab</a>
        </div>

        <div class="row">
          <div class="col">
            <label class="muted">Resolved URL</label>
            <div id="url" class="urlbar">—</div>
          </div>
        </div>
      </div>
      <footer>
        Using: <code>/api/media/auto</code> or <code>/api/media/transcode</code> from your <code>media.py</code>.
      </footer>
    </section>
  </main>

  <script>
    const listEl = document.getElementById('list');
    const filterEl = document.getElementById('filter');
    const player = document.getElementById('player');
    const selectedEl = document.getElementById('selected');
    const urlEl = document.getElementById('url');
    const btnPlayAuto = document.getElementById('btnPlayAuto');
    const btnForce = document.getElementById('btnForceTranscode');
    const btnStop = document.getElementById('btnStop');
    const rawLink = document.getElementById('rawLink');
    const countEl = document.getElementById('count');
    const startEl = document.getElementById('start');

    let allFiles = [];
    let selectedPath = null;

    // Fetch the indexed file list from your FastAPI backend
    async function loadFiles() {
      const res = await fetch('/api/media/path/list');
      const data = await res.json();
      allFiles = (data || []).sort((a, b) => a.localeCompare(b));
      countEl.textContent = allFiles.length.toString();
      renderList();
    }

    // Render the left list with optional filter
    function renderList() {
      const q = (filterEl.value || '').toLowerCase();
      listEl.innerHTML = '';
      allFiles
        .filter(p => p.toLowerCase().includes(q))
        .forEach(p => {
          const div = document.createElement('div');
          div.className = 'item' + (p === selectedPath ? ' active' : '');
          div.textContent = p;
          div.title = p;
          div.tabIndex = 0;
          div.role = 'option';
          div.addEventListener('click', () => selectPath(p));
          div.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') { selectPath(p); }
          });
          listEl.appendChild(div);
        });
    }

    function selectPath(p) {
      selectedPath = p;
      selectedEl.textContent = p || '—';
      urlEl.textContent = '—';
      rawLink.href = '#';
      // Update active class
      [...listEl.children].forEach(c => c.classList.toggle('active', c.textContent === p));
    }

    // Build URLs to your endpoints
    function buildAutoUrl() {
      if (!selectedPath) return null;
      const encoded = encodeURIComponent(selectedPath);
      const start = Number(startEl.value || 0);
      // /media/auto ignores start time by design (since it may direct-stream),
      // but we can append &start for your transcode route if you later wire it through.
      return `/api/media/auto?path=${encoded}${start > 0 ? `&start=${start}` : ''}`;
    }

    function buildTranscodeUrl() {
      if (!selectedPath) return null;
      const encoded = encodeURIComponent(selectedPath);
      const start = Number(startEl.value || 0);
      // Match your defaults: height=720, v_bitrate=3000k, a_bitrate=128k
      return `/api/media/transcode?path=${encoded}&height=720&v_bitrate=3000k&a_bitrate=128k${start > 0 ? `&start=${start}` : ''}`;
    }

    // Wire up controls
    btnPlayAuto.addEventListener('click', () => {
      const url = buildAutoUrl();
      if (!url) return alert('Pick a file on the left first.');
      player.src = url;
      player.play().catch(()=>{});
      urlEl.textContent = url;
      rawLink.href = url;
    });

    btnForce.addEventListener('click', () => {
      const url = buildTranscodeUrl();
      if (!url) return alert('Pick a file on the left first.');
      player.src = url;
      player.play().catch(()=>{});
      urlEl.textContent = url;
      rawLink.href = url;
    });

    btnStop.addEventListener('click', () => {
      player.pause();
      player.removeAttribute('src'); // drop reference to stop network
      player.load();
      urlEl.textContent = '—';
      rawLink.href = '#';
    });

    filterEl.addEventListener('input', renderList);

    // Kick things off
    loadFiles();
  </script>
</body>
</html>
